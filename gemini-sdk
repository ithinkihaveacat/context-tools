#!/usr/bin/env bash

set -e

# Main output directory for repomix
MIX_DIR="build/gemini-sdk-mix"

# Google AI GenAI SDK repo
URL_SDK="https://github.com/googleapis/js-genai/archive/refs/heads/main.zip"
ZIP_FILE_SDK="build/gemini-sdk/main.zip"
EXTRACT_DIR_SDK="build/gemini-sdk"
REPO_DIR_SDK="$EXTRACT_DIR_SDK/js-genai-main"

# Gemini Cookbook example
URL_COOKBOOK="https://raw.githubusercontent.com/google-gemini/cookbook/main/examples/Book_illustration.ipynb"

OUTPUT_FILE="context/gemini-sdk.txt"

require() {
    hash "$@" || { echo "Error: Command '$1' not found." >&2; exit 127; }
}

require curl
require unzip
require repomix
require cp
require rm

# Clean and create directories
mkdir -p build/gemini-sdk "$MIX_DIR"
rm -rf "$MIX_DIR"/*

# --- Source 1: Google AI GenAI SDK ---
echo "Downloading Google AI GenAI SDK..."
curl -sSL -o "$ZIP_FILE_SDK" "$URL_SDK"
echo "Extracting SDK..."
rm -rf "$REPO_DIR_SDK"
unzip -o -q "$ZIP_FILE_SDK" -d "$EXTRACT_DIR_SDK"
echo "Copying SDK source to mix directory..."
mkdir -p "$MIX_DIR/js-genai"
cp -R "$REPO_DIR_SDK/src" "$MIX_DIR/js-genai/"

# --- Source 2: Gemini Cookbook example ---
echo "Downloading Gemini Cookbook example..."
mkdir -p "$MIX_DIR/cookbook"
curl -sSL -o "$MIX_DIR/cookbook/Book_illustration.ipynb" "$URL_COOKBOOK"

# --- Run repomix ---
echo "Running repomix on all sources..."
repomix "$MIX_DIR" --include="**" --no-security-check --quiet -o "$OUTPUT_FILE"
echo "Successfully created $OUTPUT_FILE"