#!/usr/bin/env bash

set -e

# Main output directory for repomix
MIX_DIR="build/inky-frame-mix"

# Inky Frame repo
URL_INKY="https://github.com/pimoroni/inky-frame/archive/refs/heads/main.zip"
ZIP_FILE_INKY="build/inky-frame-doc/main.zip"
EXTRACT_DIR_INKY="build/inky-frame-doc"
DOCS_DIR_INKY="$EXTRACT_DIR_INKY/inky-frame-main"

# Pimoroni Pico repo
URL_PICO="https://github.com/pimoroni/pimoroni-pico/archive/refs/heads/main.zip"
ZIP_FILE_PICO="build/pico-doc/main.zip"
EXTRACT_DIR_PICO="build/pico-doc"
DOCS_DIR_PICO="$EXTRACT_DIR_PICO/pimoroni-pico-main"

# mpremote documentation
URL_MPREMOTE="https://docs.micropython.org/en/latest/_sources/reference/mpremote.rst.txt"

OUTPUT_FILE="context/inky-frame.txt"

require() {
    hash "$@" || { echo "Error: Command '$1' not found." >&2; exit 127; }
}

require curl
require unzip
require repomix
require cp
require rm

# Clean and create directories
mkdir -p build/inky-frame-doc build/pico-doc "$MIX_DIR"
rm -rf "$MIX_DIR"/*

# --- Source 1: Inky Frame ---
echo "Downloading Inky Frame repository..."
curl -sSL -o "$ZIP_FILE_INKY" "$URL_INKY"
echo "Extracting Inky Frame repository..."
rm -rf "$DOCS_DIR_INKY"
unzip -o -q "$ZIP_FILE_INKY" -d "$EXTRACT_DIR_INKY"
echo "Copying Inky Frame source to mix directory..."
mkdir -p "$MIX_DIR/inky-frame"
cp -R "$DOCS_DIR_INKY/docs" "$MIX_DIR/inky-frame/"
cp -R "$DOCS_DIR_INKY/examples" "$MIX_DIR/inky-frame/"
cp -R "$DOCS_DIR_INKY/modules" "$MIX_DIR/inky-frame/"

# --- Source 2: Pimoroni Pico (picographics) ---
echo "Downloading Pimoroni Pico repository..."
curl -sSL -o "$ZIP_FILE_PICO" "$URL_PICO"
echo "Extracting Pimoroni Pico repository..."
rm -rf "$DOCS_DIR_PICO"
unzip -o -q "$ZIP_FILE_PICO" -d "$EXTRACT_DIR_PICO"
echo "Copying picographics module to mix directory..."
mkdir -p "$MIX_DIR/pico"
cp -R "$DOCS_DIR_PICO/micropython/modules/picographics" "$MIX_DIR/pico/"

# --- Source 3: mpremote docs ---
echo "Downloading mpremote documentation..."
mkdir -p "$MIX_DIR/mpremote"
curl -sSL -o "$MIX_DIR/mpremote/mpremote.rst.txt" "$URL_MPREMOTE"

# --- Run repomix ---
echo "Running repomix on all sources..."
repomix "$MIX_DIR" --include="**" --no-security-check --quiet -o "$OUTPUT_FILE"
echo "Successfully created $OUTPUT_FILE"
